name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install dependencies
        run: |
          brew install whisper-cpp ffmpeg

      - name: Set CGO flags
        run: |
          WHISPER_PREFIX=$(brew --prefix whisper-cpp)
          echo "CGO_CFLAGS=-I${WHISPER_PREFIX}/include -I${WHISPER_PREFIX}/libexec/include" >> $GITHUB_ENV
          echo "CGO_LDFLAGS=-L${WHISPER_PREFIX}/lib -L${WHISPER_PREFIX}/libexec/lib -lwhisper -lggml -lggml-base" >> $GITHUB_ENV

      - name: Build
        run: |
          go mod download
          go build -o ivrit_ai-macos-amd64 ./cmd/ivrit_ai_gui
        env:
          CGO_ENABLED: 1

      - name: Create macOS app bundle (optional)
        run: |
          mkdir -p IvritAI.app/Contents/MacOS
          mkdir -p IvritAI.app/Contents/Resources
          cp ivrit_ai-macos-amd64 IvritAI.app/Contents/MacOS/ivrit_ai
          chmod +x IvritAI.app/Contents/MacOS/ivrit_ai

          # Copy icon
          cp icons/icon.icns IvritAI.app/Contents/Resources/

          # Create Info.plist
          cat > IvritAI.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>ivrit_ai</string>
              <key>CFBundleIdentifier</key>
              <string>ai.ivrit.transcription</string>
              <key>CFBundleName</key>
              <string>Ivrit.AI Transcription</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundleIconFile</key>
              <string>icon</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF

          # Create DMG
          hdiutil create -volname "Ivrit.AI" -srcfolder IvritAI.app -ov -format UDZO ivrit_ai-macos.dmg

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            ivrit_ai-macos-amd64
            ivrit_ai-macos.dmg

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            cmake \
            libgl-dev \
            libx11-dev \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libxxf86vm-dev \
            libxfixes-dev \
            libx11-xcb-dev \
            libxcb1-dev \
            libwayland-dev \
            libwayland-egl-backend-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-0 \
            libxkbcommon-x11-dev \
            libgtk-3-dev \
            libvulkan-dev \
            libegl1-mesa-dev \
            ffmpeg

      - name: Install whisper.cpp
        run: |
          git clone --depth 1 https://github.com/ggerganov/whisper.cpp.git /tmp/whisper
          cd /tmp/whisper
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON
          cmake --build build -j$(nproc)
          sudo mkdir -p /usr/local/lib /usr/local/include
          sudo cp build/src/libwhisper.so* /usr/local/lib/ || true
          sudo cp build/ggml/src/libggml*.so* /usr/local/lib/ || true
          sudo cp include/whisper.h /usr/local/include/
          sudo cp ggml/include/*.h /usr/local/include/
          sudo ldconfig

      - name: Build
        run: |
          go mod download
          go build -o ivrit_ai-linux-amd64 ./cmd/ivrit_ai_gui
        env:
          CGO_ENABLED: 1

      - name: Create tarball
        run: |
          mkdir -p dist/bin dist/share/applications dist/share/icons/hicolor/256x256/apps
          cp ivrit_ai-linux-amd64 dist/bin/ivrit_ai
          cp ivrit-ai-transcription.desktop dist/share/applications/
          cp icons/icon.png dist/share/icons/hicolor/256x256/apps/ivrit-ai-transcription.png
          cp README.md LICENSE dist/
          cd dist && tar -czf ../ivrit_ai-linux-amd64.tar.gz * && cd ..

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: ivrit_ai-linux-amd64.tar.gz

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Set up MSYS2
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            git
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-ffmpeg

      - name: Build whisper.cpp
        shell: msys2 {0}
        run: |
          git clone --depth 1 https://github.com/ggerganov/whisper.cpp.git /tmp/whisper
          cd /tmp/whisper
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON
          cmake --build build
          cmake --install build --prefix /mingw64

      - name: Generate Windows resources
        shell: msys2 {0}
        run: |
          export PATH="$(echo /c/hostedtoolcache/windows/go/1.21*/x64)/bin:/mingw64/bin:$PATH"
          go install github.com/tc-hib/go-winres@latest
          cd cmd/ivrit_ai_gui
          $(go env GOPATH)/bin/go-winres make

      - name: Build
        shell: msys2 {0}
        run: |
          export PATH="$(echo /c/hostedtoolcache/windows/go/1.21*/x64)/bin:/mingw64/bin:$PATH"
          go mod download
          go build -o ivrit_ai-windows-amd64.exe ./cmd/ivrit_ai_gui
        env:
          CGO_ENABLED: 1

      - name: Create zip
        run: |
          Compress-Archive -Path ivrit_ai-windows-amd64.exe,README.md,LICENSE -DestinationPath ivrit_ai-windows-amd64.zip

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: ivrit_ai-windows-amd64.zip

  release:
    name: Create Release
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/macos-build/ivrit_ai-macos-amd64
            artifacts/macos-build/ivrit_ai-macos.dmg
            artifacts/linux-build/ivrit_ai-linux-amd64.tar.gz
            artifacts/windows-build/ivrit_ai-windows-amd64.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
